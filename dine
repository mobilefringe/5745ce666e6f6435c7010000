<div class="header_banner dine_banner">
    <div class="main_container">
        <h4 class="header_banner_heading">Dining</h4>
    </div>
</div>

<div class="main_container mobile_padding">
    <div class="visible_phone position_relative">
        <a class="mobile_header" href="/map">Center Map</a>
        <a class="mobile_header" href="#" id="cat_dd2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            Select Category <i class="fa fa-chevron-down visible_phone pull-right"></i>
        </a>
        <ul id="category_container2" class="dropdown-menu" aria-labelledby="cat_dd2">
            <li href="#" class="show_all_stores">All</li>
           
        </ul>
    </div>
    <div class="store_nav hidden_phone">
        <div class="row">
            <div class="col-md-2">
                <a href="#" id="cat_dd" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span class="text-uppercase current_category">ALL CUISINE</span>
                    <img src="//codecloud.cdn.speedyrails.net/sites/57f503036e6f6454f2010000/image/png/1463153622000/chevron_down.png" class="category_icon" alt="">
                </a>
                <ul id="category_container" class="dropdown-menu" aria-labelledby="cat_dd">
                    <li href="#" class="active show_all_stores">All Cuisine</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row content_container">
        <!--<div class="col-md-12">-->
        <!--    <span class="store_initial hidden_now" id="cat_name"></span>-->
        <!--</div>-->
        <div id="store_list_container">
            <script id="store_list_template" type="x-tmpl-mustache/text">
                <!--<span style="{{show}}" class="store_initial open_stores" data-initial="{{data_initial}}">
                    {{initial}}
                    <i class="fa fa-chevron-down visible_phone pull-right"></i>
                </span>-->
                <div class="cats_row open_{{data_initial}} col-sm-3" data-cat="{{subcat_list}}">
                    <div class="store_container">
                        {{#is_new_store}}<img class="new_store_tag" src="//codecloud.cdn.speedyrails.net/sites/5b5a39ff6e6f64136f3c0000/image/png/1532704917337/tag-new.png"/>{{/is_new_store}}
                        <div class="store_logo_container">
                            <img src="{{store_front_url}}" style="{{show_main_image}}" class="store_list_logo" />
                        </div>
                        <div class="store_data_container">
                            <p class="store_list_name"><a href="/stores/{{slug}}">{{name}}</a></p>
                            <p class="today_store_hours" id="today_store_hour_{{id}}">Hours: {{hour_string}}</p>
                        </div>
                    </div>
                </div>
            </script>
        </div>
    </div>
</div>

<script id="category_template" type="x-tmpl-mustache/text">
    <li class="show_cat_stores" data-id="{{id}}">{{name}}</li>    
</script>

<style>
    #category_container {
        left: 10px;
        right: auto;
    }
    #category_container li.active {
        color: #79a185;
    }
</style>
<script>
    $(document).ready(function(e){
        init(e);
        loadMallDataCached(renderPage);
        show_cat_stores();
    })
    
    function renderPage(){
        var dining_cat = getCategoryDetailsByName('Dining');
        var subcategories = getSubcategoriesByParentID(dining_cat.id);
        // subcategories to dropdown
        $.each( subcategories , function( key, val ){
            $("#category_container").append("<li class='show_cat_stores' data-id='"+val.id+"'>"+val.name+"</li>");
            $("#category_container2").append("<li class='show_cat_stores' data-id='"+val.id+"'>"+val.name+"</li>");
        });
        // category_container
        var stores = getStoresListBySubcategory();
        // var stores = [];
        // var s1 = getStoresListByCategoryID(4082)
        // var s2 = getStoresListByCategoryID(4083)
        // var s3 = getStoresListByCategoryID(4084)
       
        // stores = stores.concat(s1)
        // stores = stores.concat(s2)
        // stores = stores.concat(s3)
        
        // var newarr = [];
        // var unique = {};
        // $.each(stores, function(i,v){
        //     if (!unique[v.slug]) {
        //         newarr.push(v);
        //         unique[v.slug] = v;
        //     }
        // })
        $.each(stores, function(key, val){
            //check if there's image for store, if not assign default
            if(!val.store_front_url ||  val.store_front_url.indexOf('missing.png') > -1 || val.store_front_url.length === 0){
                val.store_front_url = site_json.default_image;
            }
            //get today's hours per store
            var hour_ids = val.store_hours;
            if (hour_ids != null){
                var hours = getHoursForStoreSlug(val.slug).sortBy(function(o){ return o.day_of_week });
                today_day_of_week = moment().day();
                var todays_hour = hours.filter(function(o){ return today_day_of_week === o.day_of_week; })[0];
                var open_time = moment(todays_hour.open_time).tz(getPropertyTimeZone());
                var close_time = moment(todays_hour.close_time).tz(getPropertyTimeZone());
                if (todays_hour.is_closed == true){
                    val.hour_string = "Closed"
                } else {
                    val.hour_string = open_time.format("h:mma") + " - " + close_time.format("h:mma");
                } 
            } else {
                $('#today_store_hour_'+val.id).hide();
            }
            
            //create a subcat list
            if(val.subcategories != null && val.subcategories != undefined){
                val.subcat_list = val.subcategories.join(',');
            }
            
        });
        
        stores.sortBy(function(o){ return o.name })
        renderStoreList('#store_list_container','#store_list_template', stores, "stores", "A", "Z");
        // var categories = getStoreCategories();
        // renderGeneral('#category_container, #category_container2', '#category_template', categories);
        show_content();
        show_cat_stores();
    }
    function show_cat_stores(){
        $('.show_cat_stores').click(function(e){
            var cat_id = $(this).attr('data-id');
            $('.active').removeClass('active');
            $(this).addClass('active');
            var rows = $('.cats_row');
            rows.hide();
            $('.store_initial').hide();
            $('#current_category').text($(this).text());
            // $('#cat_name').css('display', 'block');
            $('#store_list_container').addClass("full_width");
            $.each(rows, function(i, val){
                var cat_array = val.getAttribute('data-cat').split(',');
                if ($.inArray(cat_id, cat_array) >= 0){
                    $(val).show();
                }
            });
            $('html, body').animate({scrollTop : 0},800);
            e.preventDefault();
        });
        $('.show_all_stores').click(function(e){
            $('#store_list_container, #store_list_container2').removeClass("full_width");
            $('.active_cat').removeClass('active_cat');
            $(this).addClass('active_cat');
            var rows = $('.cats_row');
            if ($(window).width() > 768){
                rows.show();
            }
            else{
                rows.hide();
            }
            $.each($('.store_initial'), function(i, val){
               if ($(val).text().trim().length > 0){
                   $(val).show();
               } 
            });
            
            $('#cat_name').hide();
            e.preventDefault();
        });
        
    }
</script>